<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PAGO DE MATRICULA</title>
  <style>
   .imagen-container img { display:block; margin-left:auto; margin-right:auto; }
    :root{
      --bg:#0b1020; --panel:#111832; --muted:#7b88a8; --text:#e7ecff;
      --brand:#6ee7b7; --brand-2:#8ab4ff; --danger:#ff6b6b; --warn:#ffd166; --ok:#7ae582;
      --ring: 0 0 0 3px rgba(110,231,183,.25); --radius: 16px;
    }
    [data-theme="light"]{ --bg:#f5f7ff; --panel:#ffffff; --text:#0e1430; --muted:#5b6688; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
      background: radial-gradient(1200px 600px at 10% -10%, #1b2550, transparent),
                  radial-gradient(1000px 800px at 110% 10%, #193b3f, transparent),
                  var(--bg);
      color:var(--text); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      transition: background .3s ease, color .3s ease;
    }
    [data-theme="light"] body, [data-theme="light"]{ background: var(--bg); }

    .container{max-width:1100px; margin:auto; padding:28px}
    header{display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:16px}
    .brand{display:flex; gap:12px; align-items:center}
    .logo{width:38px;height:38px;border-radius:12px;background:linear-gradient(135deg,var(--brand),var(--brand-2)); box-shadow:0 10px 25px rgba(106,175,255,.25)}
    h1{font-size:1.35rem; margin:0; letter-spacing:.2px}

    .grid{display:grid; grid-template-columns: 1.3fr .7fr; gap:22px}
    @media (max-width: 960px){ .grid{grid-template-columns:1fr} }

    .card{background:linear-gradient(180deg, #121a36, #0f1731); border:1px solid #263058; border-radius:var(--radius); box-shadow:0 10px 30px rgba(13,19,49,.35); overflow:hidden}
    [data-theme="light"] .card{background:#ffffff; border-color:#e3e7ff; box-shadow:0 10px 20px rgba(0,0,0,.05)}
    .card h2{font-size:1rem; padding:18px 18px 0 18px; margin:0}
    .card .body{padding:18px}
    .muted{color:var(--muted)}

    .steps{display:grid; grid-template-columns:repeat(3,1fr); gap:8px; padding:18px; border-bottom:1px solid #23305c}
    [data-theme="light"] .steps{border-bottom-color:#eef1ff}
    .step{display:flex; align-items:center; gap:10px; padding:10px; border-radius:12px; background:#0e1430}
    [data-theme="light"] .step{background:#f2f5ff}
    .step.active{outline:var(--ring); background:#0f1a3e}
    [data-theme="light"] .step.active{background:#e8f8f3}
    .badge{width:26px;height:26px;border-radius:8px; background:linear-gradient(135deg,var(--brand-2),#6ee7b7); display:grid; place-items:center; font-weight:700; color:#0a0f20}

    .progress{height:8px; background:#0e1430; margin:8px 18px 0; border-radius:999px; overflow:hidden; border:1px solid #23305c}
    [data-theme="light"] .progress{background:#eef1ff; border-color:#dbe2ff}
    .progress-bar{height:100%; background:linear-gradient(90deg,var(--brand),var(--brand-2)); transition:width .3s ease}

    form{display:grid; gap:14px}
    .row{display:grid; grid-template-columns: repeat(12, 1fr); gap:12px}
    .col-6{grid-column: span 6} .col-4{grid-column: span 4} .col-8{grid-column: span 8} .col-12{grid-column: span 12}
    @media (max-width: 720px){ .row{grid-template-columns:1fr} .col-6,.col-4,.col-8,.col-12{grid-column:1} }

    label{display:block; font-size:.88rem; color:#c5d0ff; margin-bottom:6px}
    [data-theme="light"] label{color:#2a335a}
    input, select{width:100%; padding:12px 12px; border-radius:12px; background:#0b122b; border:1px solid #263058; color:var(--text); outline:none; transition:.2s border, .2s box-shadow}
    [data-theme="light"] input, [data-theme="light"] select{background:#fff; color:#0e1430; border-color:#dbe2ff}
    input:focus, select:focus{border-color: #73e6c2; box-shadow: var(--ring)}
    input::placeholder{color:#8390b8}

    .help{font-size:.8rem; color:#9caddb}
    .error{font-size:.82rem; color:var(--danger)}

    .actions{display:flex; gap:12px; justify-content:flex-end; margin-top:10px}
    .btn{padding:12px 16px; border:1px solid #263058; background:#0c1535; color:var(--text); border-radius:12px; cursor:pointer}
    [data-theme="light"] .btn{background:#f6f8ff; color:#0e1430; border-color:#dbe2ff}
    .btn.primary{background:linear-gradient(180deg, #57ddbb, #48caa7); color:#071422; font-weight:700; border:none}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .btn.link{background:transparent; border:none; color:#9cc5ff; text-decoration:underline; padding:0}

    .summary{display:grid; gap:14px}
    .row-between{display:flex; justify-content:space-between; align-items:center}
    .hr{height:1px; background:#23305c}
    [data-theme="light"] .hr{background:#e9eeff}
    .tag{font-size:.8rem; padding:4px 8px; border-radius:999px; border:1px dashed #3a4a87; color:#a5b7ff}
    [data-theme="light"] .tag{border-color:#c9d7ff; color:#4a64c0}
    .ok{color:var(--ok)}

    .notice{background:#0d1d3c; border:1px solid #25407e; padding:12px; border-radius:12px; font-size:.9rem}
    [data-theme="light"] .notice{background:#f2f6ff; border-color:#dbe2ff}

    .tabs{display:flex; gap:8px; border-bottom:1px solid #23305c; margin-bottom:10px}
    [data-theme="light"] .tabs{border-bottom-color:#e9eeff}
    .tab{padding:8px 12px; border-radius:10px 10px 0 0; background:#0e1430; cursor:pointer; user-select:none}
    [data-theme="light"] .tab{background:#eef1ff}
    .tab.active{background:#152047; font-weight:700}
    [data-theme="light"] .tab.active{background:#e8f8f3}

    .dropzone{display:grid; place-items:center; text-align:center; padding:16px; border:1px dashed #3a4a87; border-radius:12px; background:#0b122b; color:#cfe0ff}
    .dropzone.drag{outline:var(--ring)}
    .preview{margin-top:10px; display:grid; gap:8px}
    .preview img{max-width:100%; border-radius:12px; border:1px solid #2a3a70}

    .ticket{display:grid; gap:14px}
    .ticket .qr{width:110px;height:110px;border-radius:12px;background:repeating-linear-gradient(45deg,#1b2857 0 10px,#07112c 10px 20px); border:1px solid #2b3d7d; object-fit:cover}
    .code{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

    #confetti{position:fixed; inset:0; pointer-events:none}

    @media print{
      header, .steps, .progress, .summary .help, .actions, form, aside{ display:none !important }
      #comprobante{ display:block !important }
      body{ background:#fff }
      .card{ border:none; box-shadow:none }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>PAGO DE MATRICULA</h1>
          <div class="muted" style="font-size:.9rem"></div>
        </div>
      </div>
      <!-- ✅ NO hay </div> extra aquí -->
      <div style="display:flex; gap:12px; align-items:center">
        <span class="tag" id="userTag" title="Usuario conectado" hidden></span>
        <button class="btn" id="themeToggle" aria-pressed="false" title="Cambiar tema">Tema</button>
        <button class="btn" id="logout">Cerrar sesión</button>
        <div class="tag">Moneda: PEN (S/)</div>
      </div>
    </header>

    <div class="grid">
      <!-- Columna principal -->
      <section class="card" aria-labelledby="titulo-form">
        <div class="steps" role="tablist" aria-label="Progreso de matrícula">
          <div id="s1" class="step active" role="tab" aria-selected="true"><div class="badge">1</div> Datos del estudiante</div>
          <div id="s2" class="step" role="tab" aria-selected="false"><div class="badge">2</div> Pago</div>
          <div id="s3" class="step" role="tab" aria-selected="false"><div class="badge">3</div> Comprobante</div>
        </div>

        <div class="progress" aria-hidden="true">
          <div class="progress-bar" id="progressBar" style="width:33%"></div>
        </div>

        <h2 id="titulo-form">FORMULARIO</h2>
        <div class="body">
          <!-- Paso 1 -->
          <form id="formAlumno" novalidate>
            <div class="row">
              <div class="col-6">
                <label for="dni">Documento (DNI):</label>
                <input id="dni" name="dni" inputmode="numeric" autocomplete="off" placeholder="Ejem: 71234567" required minlength="8" maxlength="8" />
                <div class="error" data-error="dni"></div>
              </div>
              <div class="col-6">
                <label for="email">Correo:</label>
                <input id="email" name="email" type="email" placeholder="tucorreo@dominio.com" required />
                <div class="error" data-error="email"></div>
              </div>
              <div class="col-6">
                <label for="nombre">Nombres:</label>
                <input id="nombre" name="nombre" placeholder="Tu nombre" required />
                <div class="error" data-error="nombre"></div>
              </div>
              <div class="col-6">
                <label for="apellidos">Apellidos:</label>
                <input id="apellidos" name="apellidos" placeholder="Tus apellidos" required />
                <div class="error" data-error="apellidos"></div>
              </div>

              <div class="col-8">
                <label for="programa">Carrera:</label>
                <select id="programa" name="programa" required>
                  <option value="" disabled selected>Selecciona una Carrera</option>
                  <option value="SIS">Desarrollo de Sistema</option>
                  <option value="ADM">Administración</option>
                  <option value="DER">Efermeria</option>
                  <option value="ARQ">Turismo</option>
                </select>
                <div class="error" data-error="programa"></div>
              </div>
              <div class="col-4">
                <label for="turno">Turno:</label>
                <select id="turno" name="turno" required>
                  <option value="" disabled selected>Seleccione Turno</option>
                  <option>Mañana</option>
                  <option>Noche</option>
                </select>
                <div class="error" data-error="turno"></div>
              </div>


              <div class="col-4">
                <label for="periodo">Ciclo:</label>
                <select id="periodo" name="periodo" required>
                  <option value="" disabled selected>Seleccione ciclo</option>
                  <option>1er Ciclo</option>
                  <option>2do Ciclo</option>
                  <option>3er Ciclo</option>
                  <option>4to Ciclo</option>
                  <option>5to Ciclo</option>
                  <option>6to Ciclo</option>
                </select>
                <div class="error" data-error="periodo"></div>
              </div>

              <div class="col-4">
                <label for="creditos"></label>
                <input id="creditos"  />
               
                <div class="error" data-error="creditos"></div>
              </div>
             

             

              <div class="col-12 actions">
                <button type="button" class="btn" id="btnGuardar">Guardar progreso</button>
                
              </div>
            </div>
          </form>

          <!-- Paso 2 -->
          <form id="formPago" hidden novalidate>
            <div class="tabs" role="tablist" aria-label="Método de pago">
              <div class="tab active" role="tab" id="tabTarjeta" aria-selected="true">Tarjeta</div>
              <div class="tab" role="tab" id="tabYape" aria-selected="false">Yape (QR)</div>
            </div>

            <div id="pagoTarjeta">
              <div class="row">
                <div class="col-8">
                  <label for="titular">Titular de la tarjeta:</label>
                  <input id="titular" name="titular" placeholder="Como aparece en la tarjeta" />
                  <div class="error" data-error="titular"></div>
                </div>
                <div class="col-4">
                  <label for="docPago">DNI del titular:</label>
                  <input id="docPago" name="docPago" inputmode="numeric" minlength="8" maxlength="8" placeholder="71234567" />
                  <div class="error" data-error="docPago"></div>
                </div>

                <div class="col-12">
                  <label for="numero">Número de tarjeta:<span class="tag" id="brandBadge" aria-live="polite">—</span></label>
                  <input id="numero" name="numero" inputmode="numeric" autocomplete="cc-number" placeholder="1234 5678 9012 3456" maxlength="19" />
                  <div class="error" data-error="numero"></div>
                </div>
                <div class="col-4">
                  <label for="exp">Vencimiento (MM/AA):</label>
                  <input id="exp" name="exp" inputmode="numeric" placeholder="MM/AA" maxlength="5" />
                  <div class="error" data-error="exp"></div>
                </div>
                <div class="col-4">
                  <label for="cvv">CVV:</label>
                  <input id="cvv" name="cvv" inputmode="numeric" placeholder="3 dígitos" minlength="3" maxlength="3" />
                  <div class="error" data-error="cvv"></div>
                </div>
                
              </div>
            </div>

            <div id="pagoYape" hidden>
              <div class="row">
                <div class="col-6">
                  <label for="yapeTelefono">Teléfono:</label>
                  <input id="yapeTelefono" name="yapeTelefono" inputmode="numeric" placeholder="9xxxxxxxx" minlength="9" maxlength="9"/>
                  <div class="error" data-error="yapeTelefono"></div>
                </div>
                <div class="col-6">
                  <label for="yapeRef">Código de operación:</label>
                  <input id="yapeRef" name="yapeRef" inputmode="numeric" placeholder="3 codigos" minlength="3" maxlength="3" />
                  <div class="error" data-error="yapeRed"></div>
                </div>

                  
                <div class="col-12">
                  <label>Sube la imagen del QR o comprobante</label>
                  <div class="dropzone" id="dropYape">
                    Arrastra y suelta la imagen aquí o <u>haz clic</u>
                    <input type="file" id="yapeFile" accept="image/*" hidden />
                  </div>
                  <div class="preview" id="yapePreview" hidden>
                    <div class="imagen-container">
                      <img src="img/yape.jpg" id="yapeImg" class="img-fluid w-100" alt="QR Yape"/>
                      <small class="muted"></small>
                    </div>
                  </div>
                  <div class="error" data-error="yapeFile"></div>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-12">
                <center><label><input type="checkbox" id="tyc" /> Acepto términos y condiciones</label></center>
                <div class="error" data-error="tyc"></div>
              </div>

              <div class="col-12 actions">
                <button type="button" class="btn" id="back1">Atrás</button>
                <button type="submit" class="btn primary" id="btnPagar">Pagar ahora</button>
              </div>
            </div>
          </form>

          <!-- Paso 3 -->
          <section id="comprobante" hidden>
            <div class="ticket">
              <p class="ok">¡Pago aprobado! Hemos registrado tu matrícula.</p>
              <div class="row">
                <div class="col-8">
                  <div class="row-between"><strong>Alumno:</strong> <span id="rAlumno">—</span></div>
                  <div class="row-between"><strong>Carrera:</strong> <span id="rPrograma">—</span></div>
                  <div class="row-between"><strong>Turno:</strong> <span id="rturno">—</span></div>
                  <div class="row-between"><strong>Ciclo:</strong> <span id="rPeriodo">—</span></div>
                  <div class="row-between"><strong>Método:</strong> <span id="rMetodo">—</span></div>
                  <div class="row-between"><strong>Monto pagado:</strong> <span id="rMonto">—</span></div>
                  
                  <div class="row-between"><strong>Operación:</strong> <span class="code" id="rOp">—</span></div>
                </div>
                <div class="col-4" style="display:grid; place-items:center">
                  <img id="rQR" class="qr" alt="QR/Comprobante" />
                </div>
              </div>
              <div class="actions">
                <button class="btn" id="otra">Hacer otra matrícula</button>
                <button class="btn primary" id="descargar">Descargar Recibo</button>
              </div>
            </div>
          </section>
        </div>
      </section>

<!-- Columna lateral -->
<aside class="card">
  <h2>Resumen</h2>
  <div class="body summary" id="resumen">
    <div class="row-between"><span>Derecho de Matrícula</span><strong id="mIns">S/ 0.00</strong></div>
    <!-- 🔹 Se eliminaron Costo por crédito, Descuento e IGV -->
    <div class="hr"></div>
    <div class="row-between" style="font-size:1.1rem">
      <strong>Total</strong><strong id="mTotal">S/ 0.00</strong>
    </div>
    
    <div class="hr"></div>
    <div class="help">
      
    </div>
  </div>
</aside>



    

  <canvas id="confetti" hidden></canvas>

  <!-- ✅ Un solo <script> -->
  <script>
    /* ==== Sesión / Logout (funcional) ==== */
    const SESS_KEY = "demo_session_v1";
    function getSession(){ try{ return JSON.parse(localStorage.getItem(SESS_KEY)); }catch{ return null; } }
    function clearSession(){ localStorage.removeItem(SESS_KEY); }

    // Guard de autenticación
    const session = getSession();
    if(!session || !session.username){
      window.location.replace("Login.html");
    } else {
      const tag = document.getElementById("userTag");
      if (tag) { tag.textContent = "DNI: " + session.username; tag.hidden = false; }
    }

    // Botón Cerrar sesión
    document.addEventListener("DOMContentLoaded", () => {
      const btnLogout = document.getElementById("logout");
      if (btnLogout) {
        btnLogout.addEventListener("click", () => {
          clearSession();
          // Si quieres: localStorage.removeItem("draftMatricula");
          window.location.replace("Login.html");
        });
      }
    });

    /* ==== Resto de utilidades / lógica (igual que tu versión) ==== */
    const PEN = new Intl.NumberFormat('es-PE', { style: 'currency', currency: 'PEN' });
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => [...el.querySelectorAll(sel)];

    function updateProgress(step){ const pct = step===1?33: step===2?66: 100; $('#progressBar').style.width = pct + '%'; }
    const tarifas = { SIS:{credito:0,inscripcion:150}, ADM:{credito:0,inscripcion:150}, DER:{credito:0,inscripcion:150}, ARQ:{credito:0,inscripcion:150} };

    function luhnCheck(num){ const s=(num+'').replace(/\D/g,''); let sum=0,dbl=false; for(let i=s.length-1;i>=0;i--){ let d=+s[i]; if(dbl){ d*=2; if(d>9)d-=9 } sum+=d; dbl=!dbl; } return s.length>=13 && sum%10===0; }
    function maskCard(v){ return v.replace(/\D/g,'').slice(0,16).replace(/(.{4})/g,'$1 ').trim(); }
    function maskExp(v){ return v.replace(/\D/g,'').slice(0,4).replace(/^(\d{0,2})(\d{0,2}).*/, (m,a,b)=> a+(b?'/'+b:'') ); }
    function getCardBrand(num){ const s=(num+'').replace(/\s|-/g,''); if(/^4\d{0,15}$/.test(s)) return 'Visa'; if(/^(5[1-5]|2[2-7])\d{0,14}$/.test(s)) return 'Mastercard'; if(/^3[47]\d{0,13}$/.test(s)) return 'Amex'; if(/^3(?:0[0-5]|[68])\d{0,11}$/.test(s)) return 'Diners'; return s.length? 'Desconocida' : '—'; }
    function updateBrand(){ const brand=getCardBrand($('#numero').value); $('#brandBadge').textContent=brand; $('#cvv').maxLength=(brand==='Amex')?4:3; }

function calc(){
  const p = $('#programa').value; 
  const cr = +($('#creditos').value || 0);
  const t = tarifas[p] || {credito:0, inscripcion:0};
  const mCred = cr * t.credito;
  const mIns = t.inscripcion;
  const total = mCred + mIns; // sin descuento ni IGV

  $('#mIns').textContent = PEN.format(mIns);
  $('#mTotal').textContent = PEN.format(total);
  return {mIns, mCred, total};
}




  
    function setStep(n){
      $('#formAlumno').hidden = n!==1; $('#formPago').hidden = n!==2; $('#comprobante').hidden = n!==3;
      [$('#s1'),$('#s2'),$('#s3')].forEach((el,i)=>{ el.classList.toggle('active', i===n-1); el.setAttribute('aria-selected', i===n-1 ? 'true':'false'); });
      updateProgress(n);
    }

    function showError(name,msg){ const box=document.querySelector(`[data-error="${name}"]`); if(box){ box.textContent = msg||''; } }
    function clearErrors(){ $$('.error').forEach(e=> e.textContent=''); }

    function validateAlumno(){
      clearErrors(); let ok=true;
      const dni=$('#dni').value.trim(); if(!/^\d{8,12}$/.test(dni)){ showError('dni','Ingresa 8 a 12 dígitos.'); ok=false; }
      const email=$('#email').value.trim(); if(!/^\S+@\S+\.\S+$/.test(email)){ showError('email','Correo no válido.'); ok=false; }
      if(!$('#nombre').value.trim()){ showError('nombre','Requerido.'); ok=false; }
      if(!$('#apellidos').value.trim()){ showError('apellidos','Requerido.'); ok=false; }
      if(!$('#programa').value){ showError('programa','Selecciona un programa.'); ok=false; }
      if(!$('#periodo').value){ showError('periodo','Selecciona un periodo.'); ok=false; }
       if(!$('#turno').value){ showError('turno','Selecciona un turno.'); ok=false; }
      
      return ok;
    }

    function validatePagoTarjeta(){
      let ok=true;
      if(!$('#titular').value.trim()){ showError('titular','Requerido.'); ok=false; }
      if(!/^\d{8,12}$/.test($('#docPago').value.trim())){ showError('docPago','Ingresa 8 a 12 dígitos.'); ok=false; }
      const num=$('#numero').value; if(!luhnCheck(num)){ showError('numero','Tarjeta no válida (Luhn).'); ok=false; }
      const exp=$('#exp').value;
      if(!/^\d{2}\/\d{2}$/.test(exp)) { showError('exp','Formato MM/AA.'); ok=false; }
      else {
        const [mm,aa]=exp.split('/').map(x=>+x);
        if(mm<1||mm>12){ showError('exp','Mes inválido.'); ok=false; }
        const now=new Date(); const y=now.getFullYear()%100; const m=now.getMonth()+1;
        if(aa<y || (aa===y && mm<m)) { showError('exp','Tarjeta vencida.'); ok=false; }
      }
      if(!/^\d{3,4}$/.test($('#cvv').value.trim())){ showError('cvv','CVV inválido.'); ok=false; }
      return ok;
    }

    function validatePagoYape(){
      let ok=true;
      const tel=$('#yapeTelefono').value.trim();
      if(!/^9\d{8}$/.test(tel)){ showError('yapeTelefono','Ingresa un celular válido (9 dígitos, inicia con 9).'); ok=false; }
      const file=yapeState.file;
      if(!file){ showError('yapeFile','Adjunta una imagen del QR o comprobante.'); ok=false; }
      return ok;
    }

    function saveDraft(){
      const data=Object.fromEntries($$('#formAlumno input, #formAlumno select').map(i=>[i.id,i.value]));
      localStorage.setItem('draftMatricula', JSON.stringify(data));
    }
    function loadDraft(){
      const raw=localStorage.getItem('draftMatricula'); if(!raw) return;
      try{ const data=JSON.parse(raw); Object.entries(data).forEach(([k,v])=>{ const el=$('#'+k); if(el) el.value=v; }); calc(); }catch{}
    }
    function simulatePayment(ms=1200){ return new Promise(res=> setTimeout(res, ms)); }
    function generarOperacion(){ const abc='ABCDEFGHJKMNPQRSTUVWXYZ23456789'; let s='OP-'; for(let i=0;i<10;i++){ s+=abc[Math.floor(Math.random()*abc.length)] } return s; }
    function descargarPDF(){ window.print(); }

    function createConfetti(){
      const canvas=$('#confetti'); const ctx=canvas.getContext('2d');
      const W=canvas.width=innerWidth; const H=canvas.height=innerHeight; canvas.hidden=false;
      const N=140; const parts=Array.from({length:N},()=>({ x:Math.random()*W,y:-20-Math.random()*H/2,vx:(Math.random()-.5)*2,vy:2+Math.random()*3,s:4+Math.random()*4,a:Math.random()*Math.PI,va:(Math.random()-.5)*0.2 }));
      let t=0; const T=90;
      function frame(){ ctx.clearRect(0,0,W,H); parts.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.a+=p.va; ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a); ctx.fillStyle=`hsl(${(p.y/3)%360} 80% 60%)`; ctx.fillRect(-p.s/2,-p.s/2,p.s,p.s); ctx.restore(); }); if(++t<T) requestAnimationFrame(frame); else canvas.hidden=true; }
      frame();
    }

    const yapeState={ file:null, dataURL:null };

    const tabTarjeta=$('#tabTarjeta'); const tabYape=$('#tabYape');
    const viewTarjeta=$('#pagoTarjeta'); const viewYape=$('#pagoYape');
    function setMetodo(m){
      const isTarjeta=m==='tarjeta';
      tabTarjeta.classList.toggle('active',isTarjeta);
      tabYape.classList.toggle('active',!isTarjeta);
      tabTarjeta.setAttribute('aria-selected',String(isTarjeta));
      tabYape.setAttribute('aria-selected',String(!isTarjeta));
      viewTarjeta.hidden=!isTarjeta; viewYape.hidden=isTarjeta;
      $('#rMetodo').textContent=isTarjeta?'Tarjeta':'Yape';
    }

    ['programa'].forEach(id=> $('#'+id).addEventListener('input', calc));
    ['dni','email','nombre','apellidos','periodo'].forEach(id=> $('#'+id).addEventListener('change', ()=>{}));
    $('#numero').addEventListener('input', e=> { e.target.value=maskCard(e.target.value); updateBrand(); });
    $('#exp').addEventListener('input', e=> e.target.value=maskExp(e.target.value));
    tabTarjeta.addEventListener('click', ()=> setMetodo('tarjeta'));
    tabYape.addEventListener('click', ()=> setMetodo('yape'));

    const dz=$('#dropYape'); const fileInput=$('#yapeFile'); const preview=$('#yapePreview'); const img=$('#yapeImg');
    if(dz){
      dz.addEventListener('click', ()=> fileInput.click());
      dz.addEventListener('dragover', e=>{ e.preventDefault(); dz.classList.add('drag'); });
      dz.addEventListener('dragleave', ()=> dz.classList.remove('drag'));
      dz.addEventListener('drop', e=>{ e.preventDefault(); dz.classList.remove('drag'); const f=e.dataTransfer.files[0]; if(f) handleFile(f); });
      fileInput.addEventListener('change', e=>{ const f=e.target.files[0]; if(f) handleFile(f); });
    }
    function handleFile(f){
      if(!f.type.startsWith('image/')){ showError('yapeFile','El archivo debe ser una imagen.'); return; }
      showError('yapeFile',''); yapeState.file=f;
      const reader=new FileReader();
      reader.onload=()=>{ yapeState.dataURL=reader.result; img.src=reader.result; preview.hidden=false; };
      reader.readAsDataURL(f);
    }

    $('#btnGuardar').addEventListener('click', ()=>{ saveDraft(); alert('Progreso guardado en este navegador.'); });

    $('#formAlumno').addEventListener('submit', (e)=>{
      e.preventDefault(); if(!validateAlumno()) return;
      saveDraft(); setStep(2);
      $('#titular').value = ($('#nombre').value + ' ' + $('#apellidos').value).toUpperCase();
      $('#docPago').value = $('#dni').value;
      updateBrand();
    });

    $('#back1').addEventListener('click', ()=> setStep(1));

    $('#formPago').addEventListener('submit', async (e)=>{
      e.preventDefault(); clearErrors();
      if(!$('#tyc').checked){ showError('tyc','Debes aceptar los T&C.'); return; }
      const metodo = tabTarjeta.classList.contains('active') ? 'tarjeta' : 'yape';
      let ok = metodo==='tarjeta' ? validatePagoTarjeta() : validatePagoYape();
      if(!ok) return;

      $('#btnPagar').disabled = true; $('#btnPagar').textContent = 'Procesando…';
      await simulatePayment(); createConfetti();
      const { total } = calc();
      $('#rAlumno').textContent = $('#nombre').value + ' ' + $('#apellidos').value + ' (' + $('#dni').value + ')';
      $('#rPrograma').textContent = $('#programa').selectedOptions[0].textContent;
      $('#rPeriodo').textContent = $('#periodo').value;
      $('#rturno').textContent = $('#turno').value;
      $('#rMonto').textContent = PEN.format(total);
   
      $('#rMetodo').textContent = (metodo==='tarjeta') ? 'Tarjeta' : 'Yape';
      $('#rOp').textContent = generarOperacion();
      if(metodo==='yape' && yapeState.dataURL){ $('#rQR').src = yapeState.dataURL; } else { $('#rQR').removeAttribute('src'); }
      setStep(3);
      $('#btnPagar').disabled = false; $('#btnPagar').textContent = 'Pagar ahora';
      localStorage.removeItem('draftMatricula');
    });

    $('#otra').addEventListener('click', ()=>{ document.querySelector('form').reset(); location.reload(); });
    $('#descargar').addEventListener('click', ()=> descargarPDF());

    const savedTheme=localStorage.getItem('theme')||'dark';
    if(savedTheme==='light'){ document.documentElement.setAttribute('data-theme','light'); $('#themeToggle').setAttribute('aria-pressed','true'); }
    $('#themeToggle').addEventListener('click', ()=>{
      const isLight=document.documentElement.getAttribute('data-theme')==='light';
      document.documentElement.setAttribute('data-theme', isLight? 'dark':'light');
      $('#themeToggle').setAttribute('aria-pressed', String(!isLight));
      localStorage.setItem('theme', isLight? 'dark':'light');
    });

    loadDraft(); calc(); updateBrand(); updateProgress(1); setMetodo('tarjeta');
  </script>
</body>
</html>
