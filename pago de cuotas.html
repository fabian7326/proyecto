<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PAGO DE CUOTAS</title>
  <style>
   .imagen-container img { display:block; margin-left:auto; margin-right:auto; }
    :root{
      --bg:#0b1020; --panel:#111832; --muted:#7b88a8; --text:#e7ecff;
      --brand:#6ee7b7; --brand-2:#8ab4ff; --danger:#ff6b6b; --warn:#ffd166; --ok:#7ae582;
      --ring: 0 0 0 3px rgba(110,231,183,.25); --radius: 16px;
    }
    [data-theme="light"]{ --bg:#f5f7ff; --panel:#ffffff; --text:#0e1430; --muted:#5b6688; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
      background: radial-gradient(1200px 600px at 10% -10%, #1b2550, transparent),
                  radial-gradient(1000px 800px at 110% 10%, #193b3f, transparent),
                  var(--bg);
      color:var(--text); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      transition: background .3s ease, color .3s ease;
    }
    [data-theme="light"] body, [data-theme="light"]{ background: var(--bg); }

    .container{max-width:1100px; margin:auto; padding:28px}
    header{display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:16px}
    .brand{display:flex; gap:12px; align-items:center}
    .logo{width:38px;height:38px;border-radius:12px;background:linear-gradient(135deg,var(--brand),var(--brand-2)); box-shadow:0 10px 25px rgba(106,175,255,.25)}
    h1{font-size:1.35rem; margin:0; letter-spacing:.2px}

    .grid{display:grid; grid-template-columns: 1.3fr .7fr; gap:22px}
    @media (max-width: 960px){ .grid{grid-template-columns:1fr} }

    .card{background:linear-gradient(180deg, #121a36, #0f1731); border:1px solid #263058; border-radius:var(--radius); box-shadow:0 10px 30px rgba(13,19,49,.35); overflow:hidden}
    [data-theme="light"] .card{background:#ffffff; border-color:#e3e7ff; box-shadow:0 10px 20px rgba(0,0,0,.05)}
    .card h2{font-size:1rem; padding:18px 18px 0 18px; margin:0}
    .card .body{padding:18px}
    .muted{color:var(--muted)}

    .steps{display:grid; grid-template-columns:repeat(3,1fr); gap:8px; padding:18px; border-bottom:1px solid #23305c}
    [data-theme="light"] .steps{border-bottom-color:#eef1ff}
    .step{display:flex; align-items:center; gap:10px; padding:10px; border-radius:12px; background:#0e1430}
    [data-theme="light"] .step{background:#f2f5ff}
    .step.active{outline:var(--ring); background:#0f1a3e}
    [data-theme="light"] .step.active{background:#e8f8f3}
    .badge{width:26px;height:26px;border-radius:8px; background:linear-gradient(135deg,var(--brand-2),#6ee7b7); display:grid; place-items:center; font-weight:700; color:#0a0f20}

    .progress{height:8px; background:#0e1430; margin:8px 18px 0; border-radius:999px; overflow:hidden; border:1px solid #23305c}
    [data-theme="light"] .progress{background:#eef1ff; border-color:#dbe2ff}
    .progress-bar{height:100%; background:linear-gradient(90deg,var(--brand),var(--brand-2)); transition:width .3s ease}

    form{display:grid; gap:14px}
    .row{display:grid; grid-template-columns: repeat(12, 1fr); gap:12px}
    .col-6{grid-column: span 6} .col-4{grid-column: span 4} .col-8{grid-column: span 8} .col-12{grid-column: span 12}
    @media (max-width: 720px){ .row{grid-template-columns:1fr} .col-6,.col-4,.col-8,.col-12{grid-column:1} }

    label{display:block; font-size:.88rem; color:#c5d0ff; margin-bottom:6px}
    [data-theme="light"] label{color:#2a335a}
    input, select{width:100%; padding:12px 12px; border-radius:12px; background:#0b122b; border:1px solid #263058; color:var(--text); outline:none; transition:.2s border, .2s box-shadow}
    [data-theme="light"] input, [data-theme="light"] select{background:#fff; color:#0e1430; border-color:#dbe2ff}
    input:focus, select:focus{border-color: #73e6c2; box-shadow: var(--ring)}
    input::placeholder{color:#8390b8}

    .help{font-size:.8rem; color:#9caddb}
    .error{font-size:.82rem; color:var(--danger)}

    .actions{display:flex; gap:12px; justify-content:flex-end; margin-top:10px}
    .btn{padding:12px 16px; border:1px solid #263058; background:#0c1535; color:var(--text); border-radius:12px; cursor:pointer}
    [data-theme="light"] .btn{background:#f6f8ff; color:#0e1430; border-color:#dbe2ff}
    .btn.primary{background:linear-gradient(180deg, #57ddbb, #48caa7); color:#071422; font-weight:700; border:none}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .btn.link{background:transparent; border:none; color:#9cc5ff; text-decoration:underline; padding:0}

    .summary{display:grid; gap:14px}
    .row-between{display:flex; justify-content:space-between; align-items:center}
    .hr{height:1px; background:#23305c}
    [data-theme="light"] .hr{background:#e9eeff}
    .tag{font-size:.8rem; padding:4px 8px; border-radius:999px; border:1px dashed #3a4a87; color:#a5b7ff}
    [data-theme="light"] .tag{border-color:#c9d7ff; color:#4a64c0}
    .ok{color:var(--ok)}

    .notice{background:#0d1d3c; border:1px solid #25407e; padding:12px; border-radius:12px; font-size:.9rem}
    [data-theme="light"] .notice{background:#f2f6ff; border-color:#dbe2ff}

    .tabs{display:flex; gap:8px; border-bottom:1px solid #23305c; margin-bottom:10px}
    [data-theme="light"] .tabs{border-bottom-color:#e9eeff}
    .tab{padding:8px 12px; border-radius:10px 10px 0 0; background:#0e1430; cursor:pointer; user-select:none}
    [data-theme="light"] .tab{background:#eef1ff}
    .tab.active{background:#152047; font-weight:700}
    [data-theme="light"] .tab.active{background:#e8f8f3}

    /* Adaptación específica para “Pago de Cuotas” */
    .cuota-item{padding:12px; border:1px solid #263058; border-radius:12px; background:#0b122b; color:var(--text); margin-bottom:10px; cursor:pointer}
    .cuota-item.selected{border-color:var(--brand); background:#0e1430;}
    [data-theme="light"] .cuota-item{background:#fff; color:#0e1430;}
    [data-theme="light"] .cuota-item.selected{background:#e8f8f3;}

    @media print{
      header, .steps, .progress, .summary .help, .actions, form, aside{ display:none !important }
      #comprobante{ display:block !important }
      body{ background:#fff }
      .card{ border:none; box-shadow:none }
    }

	.select-corto {
  width: 200px;   /* o el ancho que desees */
  max-width: 100%; /* para que no exceda su contenedor en pantallas pequeñas */
}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>PAGO DE CUOTAS</h1>
          <div class="muted" style="font-size:.9rem">Tus cuotas pendientes</div>
        </div>
      </div>
      <div style="display:flex; gap:12px; align-items:center">
        <span class="tag" id="userTag" title="Usuario conectado" hidden></span>
        <button class="btn" id="themeToggle" aria-pressed="false" title="Cambiar tema">Tema</button>
        <button class="btn" id="logout">Cerrar sesión</button>
      </div>
    </header>

    <div class="grid">
      <!-- Columna principal -->
	  <div class="col-12">
  <label for="cicloSelect">Ciclo:</label>
  <select id="cicloSelect" name="cicloSelect" class="select-corto" required>
    <option value="" disabled selected>Selecione un ciclo</option>
    <option value="1er Ciclo">1er Ciclo</option>
    <option value="2do Ciclo">2do Ciclo</option>
    <option value="3er Ciclo">3er Ciclo</option>
	<option value="4to Ciclo">4to Ciclo</option>
    <option value="5to Ciclo">5to Ciclo</option>
    <option value="6to Ciclo">6to Ciclo</option>

  </select>
  <div class="error" data-error="cicloSelect"></div>
</div>

      <section class="card" aria-labelledby="titulo-form">
        <div class="steps" role="tablist" aria-label="Progreso de pago">
          <div id="s1" class="step active" role="tab" aria-selected="true"><div class="badge">1</div> Selección de cuota</div>
          <div id="s2" class="step" role="tab" aria-selected="false"><div class="badge">2</div> Pago</div>
          <div id="s3" class="step" role="tab" aria-selected="false"><div class="badge">3</div> Comprobante</div>
        </div>

        <div class="progress" aria-hidden="true">
          <div class="progress-bar" id="progressBar" style="width:33%"></div>
        </div>

        <h2 id="titulo-form">Selecciona la cuota a pagar</h2>
        <div class="body">
          <!-- Paso 1: listado de cuotas -->
          <form id="formCuotas" novalidate>
            <div class="row">
              <div class="col-12">
                <div id="listaCuotas">
                  <!-- Ejemplo: varias cuotas -->
                  <div class="cuota-item" data-id="1" data-monto="S/ 350.00">1ra Cuota – S/ 350.00 – Vencida</div>
                  <div class="cuota-item" data-id="2" data-monto="S/ 350.00">2da Cuota – S/ 350.00 – Vencida</div>
                  <div class="cuota-item" data-id="3" data-monto="S/ 350.00">3ra Cuota – S/ 350.00 – Próxima</div>
                  <div class="cuota-item" data-id="4" data-monto="S/ 350.00">4ta Cuota – S/ 350.00 – Próxima</div>
                  <div class="cuota-item" data-id="5" data-monto="S/ 350.00">5ta Cuota – S/ 350.00 – Próxima</div>
                </div>
              </div>
              <div class="col-12 actions">
                <button type="button" class="btn primary" id="toPago">Continuar al pago</button>
              </div>
            </div>
          </form>

          <!-- Paso 2: pago -->
          <form id="formPago" hidden novalidate>
            <div class="tabs" role="tablist" aria-label="Método de pago">
              <div class="tab active" role="tab" id="tabTarjeta" aria-selected="true">Tarjeta</div>
              <div class="tab" role="tab" id="tabYape" aria-selected="false">Yape (QR)</div>
            </div>

            <div id="pagoTarjeta">
              <div class="row">
                <div class="col-12">
                  <label for="montoSeleccionado">Monto a pagar:</label>
                  <input id="montoSeleccionado" name="montoSeleccionado" disabled />
                </div>
                <div class="col-8">
                  <label for="titular">Titular de la tarjeta:</label>
                  <input id="titular" name="titular" placeholder="Como aparece en la tarjeta" required />
                  <div class="error" data-error="titular"></div>
                </div>
                <div class="col-4">
                  <label for="docPago">DNI del titular:</label>
                  <input id="docPago" name="docPago" inputmode="numeric" minlength="8" maxlength="8" placeholder="71234567" required />
                  <div class="error" data-error="docPago"></div>
                </div>
                <div class="col-12">
                  <label for="numero">Número de tarjeta:<span class="tag" id="brandBadge" aria-live="polite">—</span></label>
                  <input id="numero" name="numero" inputmode="numeric" autocomplete="cc-number" placeholder="1234 5678 9012 3456" maxlength="19" required />
                  <div class="error" data-error="numero"></div>
                </div>
                <div class="col-4">
                  <label for="exp">Vencimiento (MM/AA):</label>
                  <input id="exp" name="exp" inputmode="numeric" placeholder="MM/AA" maxlength="5" required />
                  <div class="error" data-error="exp"></div>
                </div>
                <div class="col-4">
                  <label for="cvv">CVV:</label>
                  <input id="cvv" name="cvv" inputmode="numeric" placeholder="3 dígitos" minlength="3" maxlength="3" required />
                  <div class="error" data-error="cvv"></div>
                </div>
              </div>
            </div>

            <div id="pagoYape" hidden>
              <div class="row">
                <div class="col-6">
  <label for="yapeTelefono">Teléfono Yape</label>
  <input id="yapeTelefono" name="yapeTelefono"
         inputmode="numeric"
         pattern="[0-9]{9}"
         placeholder="9xxxxxxxx"
         minlength="9" maxlength="9"
         required />
  <div class="error" data-error="yapeTelefono"></div>
</div>
<div class="col-6">
  <label for="yapeRef">Código de operación</label>
  <input id="yapeRef" name="yapeRef"
         inputmode="numeric"
         pattern="[0-9]{3}"
         minlength="3" maxlength="3"
         placeholder="123"
         />
  <div class="error" data-error="yapeRef"></div>
</div>

                <div class="col-12">
                  <label>Sube la imagen del QR o comprobante</label>
                  <div class="dropzone" id="dropYape">
                    Arrastra y suelta la imagen aquí o <u>Haz clic</u>
					<BR></BR>
                    <input type="file" id="yapeFile" accept="image/*" hidden />
                  </div>
                  <div class="preview" id="yapePreview">
  <div class="imagen-container">
    <img src="img/yape.jpg" id="yapeImg" class="img-fluid w-100" alt="QR Yape"/>
    <small class="muted"></small>
  </div>
</div>

                  <div class="error" data-error="yapeFile"></div>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-12">
                <CENTER><label><input type="checkbox" id="tyc" /> Acepto términos y condiciones</label></CENTER>
                <div class="error" data-error="tyc"></div>
              </div>

              <div class="col-12 actions">
                <button type="button" class="btn" id="back1">Atrás</button>
                <button type="submit" class="btn primary" id="btnPagar">Pagar cuota</button>
              </div>
            </div>
          </form>

<!-- Paso 3: comprobante -->
<section id="comprobante">
  <div class="ticket">
    <p class="ok">¡Pago aprobado! Hemos registrado tu cuota.</p>
    <div class="row">
      <div class="col-8">
        <div class="row-between"><strong>Ciclo:</strong> <span id="rCiclo"></span></div>
        <div class="row-between"><strong>Cuota:</strong> <span id="rCuota"></span></div>
        <div class="row-between"><strong>Monto pagado:</strong> <span id="rMonto"></span></div>
        <div class="row-between"><strong>Método:</strong> <span id="rMetodo"></span></div>
        <div class="row-between"><strong>Operación:</strong> <span class="code" id="rOp"></span></div>
      </div>
      <div class="col-4" style="display:grid; place-items:center">
        <p style="font-size: 0.9rem; color: #ccc; margin-top: 0.5rem;"></p>
      </div>
    </div>
    <div class="actions">
      <button class="btn" id="otra">Pagar otra cuota</button>
      <button class="btn primary" id="descargar">Descargar recibo</button>
    </div>
  </div>
</section>


      <!-- Columna lateral -->
      <aside class="card">
        <h2>Resumen</h2>
        <div class="body summary" id="resumen">
          <div class="row-between"><span>Ciclo pagado:</span><strong id="mCiclo">6toCiclo</strong></div>
          <div class="row-between"><span>Cuota:</span><strong id="mCuota">—</strong></div>
          <div class="row-between"><span>Monto:</span><strong id="mMontoTexto">S/ 0.00</strong></div>
          <div class="hr"></div>
          <div class="row-between" style="font-size:1.1rem"><strong>Total a pagar</strong><strong id="mTotalPago">S/ 0.00</strong></div>
          <div class="hr"></div>
          <div class="help">Selecciona la cuota a pagar. Luego sigue al pago.</div>
        </div>
      </aside>
    </div>
  </div>

  <canvas id="confetti" hidden></canvas>

  <script>
    const SESS_KEY = "demo_session_v1";
    function getSession(){ try{ return JSON.parse(localStorage.getItem(SESS_KEY)); }catch{ return null; } }
    function clearSession(){ localStorage.removeItem(SESS_KEY); }

    const session = getSession();
    if(!session || !session.username){
      window.location.replace("Login.html");
    } else {
      const tag = document.getElementById("userTag");
      if (tag) {
        tag.textContent = "DNI: " + session.username;
        tag.hidden = false;
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      const btnLogout = document.getElementById("logout");
      if (btnLogout) {
        btnLogout.addEventListener("click", () => {
          clearSession();
          window.location.replace("Login.html");
        });
      }
    });

    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => [...el.querySelectorAll(sel)];

    function updateProgress(step){
      const pct = step===1?33: step===2?66:100;
      $('#progressBar').style.width = pct + '%';
      [$('#s1'),$('#s2'),$('#s3')].forEach((el,i)=>{
        el.classList.toggle('active', i===step-1);
        el.setAttribute('aria-selected', i===step-1?'true':'false');
      });
    }

    // Variables de estado
    let selectedCuotaId = null;
    let selectedCicloId = null;
    let selectedMonto = 0;

// Paso 1: elegir cuota
$$('#listaCuotas .cuota-item').forEach(item => {
  item.addEventListener('click', () => {
    // ✅ Validar que se haya elegido un ciclo antes de seleccionar la cuota
    const cicloSeleccionado = $('#cicloSelect').value;
    if (!cicloSeleccionado) {
      alert('Primero selecciona un ciclo antes de elegir la cuota.');
      return;
    }

    // Quitar selección anterior y marcar la nueva
    $$('#listaCuotas .cuota-item').forEach(el => el.classList.remove('selected'));
    item.classList.add('selected');

    // Obtener datos de la cuota seleccionada
    selectedCuotaId = item.getAttribute('data-id');
    selectedMonto = item.getAttribute('data-monto');

    // Mostrar los datos en el resumen
    $('#mCuota').textContent = "Cuota #" + selectedCuotaId;
    $('#mMontoTexto').textContent = selectedMonto;

    // ✅ Actualizar también el Total a pagar
    document.getElementById("mTotalPago").textContent = selectedMonto;
  });
});

$('#toPago').addEventListener('click', () => {
  // ✅ Mantiene la validación original
  if (!selectedCuotaId) {
    alert('Por favor selecciona una cuota para continuar.');
    return;
  }

  $('#montoSeleccionado').value = selectedMonto;
  updateProgress(2);
  $('#formCuotas').hidden = true;
  $('#formPago').hidden = false;
  $('#comprobante').hidden = true;
});




    // Métodos de pago tab
    const tabTarjeta = $('#tabTarjeta'), tabYape = $('#tabYape');
    const viewTarjeta = $('#pagoTarjeta'), viewYape = $('#pagoYape');
    function setMetodo(m){
      const isTarjeta = (m==='tarjeta');
      tabTarjeta.classList.toggle('active', isTarjeta);
      tabYape.classList.toggle('active', !isTarjeta);
      tabTarjeta.setAttribute('aria-selected', String(isTarjeta));
      tabYape.setAttribute('aria-selected', String(!isTarjeta));
      viewTarjeta.hidden = !isTarjeta;
      viewYape.hidden = isTarjeta;
      $('#rMetodo').textContent = isTarjeta?'Tarjeta':'Yape';
    }
    tabTarjeta.addEventListener('click', ()=> setMetodo('tarjeta'));
    tabYape.addEventListener('click', ()=> setMetodo('yape'));

    // Simulación de pago
    function simulatePayment(ms=1200){ return new Promise(res=> setTimeout(res, ms)); }
    function generarOperacion(){ const abc='ABCDEFGHJKMNPQRSTUVWXYZ23456789'; let s='OP-'; for(let i=0;i<10;i++){ s+=abc[Math.floor(Math.random()*abc.length)] } return s; }

    $('#formPago').addEventListener('submit', async (e)=>{
      e.preventDefault();
      // Validaciones simplificadas
      if (!$('#tyc').checked) { alert('Debes aceptar términos y condiciones.'); return; }

      $('#btnPagar').disabled = true;
      $('#btnPagar').textContent = 'Procesando…';

      await simulatePayment();
      const monto = selectedMonto;
      $('#rCuota').textContent = "Cuota #" + selectedCuotaId;
      $('#rMonto').textContent = monto;
      $('#rOp').textContent = generarOperacion();

      updateProgress(3);
      $('#formPago').hidden = true;
      $('#comprobante').hidden = false;

      $('#btnPagar').disabled = false;
      $('#btnPagar').textContent = 'Pagar cuota';
    });

    $('#back1').addEventListener('click', ()=>{
      updateProgress(1);
      $('#formPago').hidden = true;
      $('#formCuotas').hidden = false;
      $('#comprobante').hidden = true;
    });

    $('#otra').addEventListener('click', ()=>{
      location.reload();
    });

    $('#descargar').addEventListener('click', ()=> window.print());

    const savedTheme = localStorage.getItem('theme') || 'dark';
    if (savedTheme==='light'){
      document.documentElement.setAttribute('data-theme','light');
      $('#themeToggle').setAttribute('aria-pressed','true');
    }
    $('#themeToggle').addEventListener('click', ()=>{
      const isLight = document.documentElement.getAttribute('data-theme')==='light';
      document.documentElement.setAttribute('data-theme', isLight?'dark':'light');
      $('#themeToggle').setAttribute('aria-pressed', String(!isLight));
      localStorage.setItem('theme', isLight?'dark':'light');
    });

    // Inicialización
    updateProgress(1);
  </script>
	
	<script>
document.addEventListener("DOMContentLoaded", () => {
  const dropZone   = document.getElementById("dropYape");
  const fileInput  = document.getElementById("yapeFile");
  const previewDiv = document.getElementById("yapePreview");
  const imgElem    = document.getElementById("yapeImg");
  const errorDiv   = document.querySelector(".error[data-error='yapeFile']");

  // Aseguramos que la imagen predeterminada esté visible al cargar el paso de Yape
  previewDiv.hidden = false;
  imgElem.src = "img/yape.jpg";  // Asegúrate que esta ruta sea correcta

  // Al hacer clic en la zona “haz clic”
  dropZone.addEventListener("click", () => {
    fileInput.click();
  });

  // Previene el default de arrastrar / soltar
  ["dragenter", "dragover", "dragleave", "drop"].forEach(evt => {
    dropZone.addEventListener(evt, e => {
      e.preventDefault();
      e.stopPropagation();
    });
  });

  // Maneja el drop
  dropZone.addEventListener("drop", e => {
    const files = e.dataTransfer.files;
    handleFiles(files);
  });

  // Maneja la selección desde el input
  fileInput.addEventListener("change", e => {
    const files = e.target.files;
    handleFiles(files);
  });

  function handleFiles(files) {
    if (!files || files.length === 0) {
      return;
    }
    const file = files[0];

    // Validar tipo MIME (debe comenzar por “image/”)
    if (!file.type.startsWith("image/")) {
      errorDiv.textContent = "Archivo no válido: por favor seleccione una imagen de QR.";
      // Opcional: restablecer el input
      fileInput.value = "";
      return;
    }

    // Opcional: validar extensiones si quieres
    const allowedExt = ["jpg","jpeg","png"];
    const ext = file.name.split(".").pop().toLowerCase();
    if (!allowedExt.includes(ext)) {
      errorDiv.textContent = "Formato no permitido: solo jpg/jpeg/png.";
      fileInput.value = "";
      return;
    }

    // Si pasa validación → procesar vista previa
    errorDiv.textContent = "";
    const reader = new FileReader();
    reader.onload = function(e) {
      imgElem.src = e.target.result;
      previewDiv.hidden = false;
    };
    reader.readAsDataURL(file);
  }
});

if (file.size > 2 * 1024 * 1024) {
  errorDiv.textContent = "La imagen es demasiado grande (máx. 2 MB).";
  fileInput.value = "";
  return;
}


</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const formCuotas = document.getElementById("formCuotas");
  const formPago = document.getElementById("formPago");

  const cicloSelect     = document.getElementById("cicloSelect");
  const listaCuotas      = document.getElementById("listaCuotas");
  const toPagoBtn        = document.getElementById("toPago");

  const tabTarjeta       = document.getElementById("tabTarjeta");
  const tabYape          = document.getElementById("tabYape");
  const viewTarjeta      = document.getElementById("pagoTarjeta");
  const viewYape         = document.getElementById("pagoYape");

  const yapeTelefono     = document.getElementById("yapeTelefono");
  const yapeRef          = document.getElementById("yapeRef");
  const yapeFile         = document.getElementById("yapeFile");
  const dropZone         = document.getElementById("dropYape");
  const yapeImg          = document.getElementById("yapeImg");
  const yapePreviewDiv   = document.getElementById("yapePreview");
  const yapeErrorDiv     = document.querySelector(".error[data-error='yapeFile']");

  const tycCheckbox      = document.getElementById("tyc");
  const btnPagar         = document.getElementById("btnPagar");

  const mCuotaText       = document.getElementById("mCuota");
  const mMontoTexto      = document.getElementById("mMontoTexto");
  const rCuota           = document.getElementById("rCuota");
  const rMonto           = document.getElementById("rMonto");
  const rMetodo          = document.getElementById("rMetodo");

  let selectedCuotaId  = null;
  let selectedMonto    = 0;
  let selectedCiclo    = null;

  // Paso 1: selección de ciclo
  cicloSelect.addEventListener("change", () => {
    // Restablecer cuota seleccionada
    selectedCuotaId = null;
    selectedMonto   = 0;
    // Limpiar selección visual
    listaCuotas.querySelectorAll('.cuota-item').forEach(el => el.classList.remove('selected'));
    mCuotaText.textContent = "—";
    mMontoTexto.textContent = "S/ 0.00";
    selectedCiclo = cicloSelect.value;
  });

  // Paso 1: selección de cuota
  listaCuotas.querySelectorAll('.cuota-item').forEach(item => {
    item.addEventListener('click', () => {
      if (!cicloSelect.value) {
        alert("Primero selecciona un ciclo antes de elegir la cuota.");
        return;
      }
      listaCuotas.querySelectorAll('.cuota-item').forEach(el => el.classList.remove('selected'));
      item.classList.add('selected');
      selectedCuotaId = item.getAttribute('data-id');
      selectedMonto   = item.getAttribute('data-monto');
      mCuotaText.textContent = "Cuota #" + selectedCuotaId;
      mMontoTexto.textContent = selectedMonto;
    });
  });

  toPagoBtn.addEventListener('click', () => {
    if (!cicloSelect.value) {
      alert("Por favor selecciona un ciclo para continuar.");
      return;
    }
    if (!selectedCuotaId) {
      alert("Por favor selecciona una cuota para continuar.");
      return;
    }
    document.getElementById("montoSeleccionado").value = selectedMonto;
    mCuotaText.textContent = "Cuota #" + selectedCuotaId;
    updateProgress(2);
    formCuotas.hidden = true;
    formPago.hidden   = false;
    document.getElementById("comprobante").hidden = true;

    // Cuando entramos al paso de pago, rellenamos datos para comprobante futuros
    rCuota.textContent = "Cuota #" + selectedCuotaId;
    rMonto.textContent = selectedMonto;
  });

  // Método de pago: tarjeta o Yape
  function setMetodo(m) {
    const isTarjeta = (m === 'tarjeta');
    tabTarjeta.classList.toggle('active', isTarjeta);
    tabYape.classList.toggle('active', !isTarjeta);
    viewTarjeta.hidden = !isTarjeta;
    viewYape.hidden    = isTarjeta;
    rMetodo.textContent = isTarjeta ? 'Tarjeta' : 'Yape';
  }
  tabTarjeta.addEventListener('click', () => setMetodo('tarjeta'));
  tabYape.addEventListener('click', () => setMetodo('yape'));

  // Validaciones específicas para Yape
  dropZone.addEventListener("click", () => yapeFile.click());
  ["dragenter", "dragover", "dragleave", "drop"].forEach(evt => {
    dropZone.addEventListener(evt, e => {
      e.preventDefault();
      e.stopPropagation();
    });
  });
  dropZone.addEventListener("drop", e => {
    const files = e.dataTransfer.files;
    handleYapeFiles(files);
  });
  yapeFile.addEventListener("change", e => {
    const files = e.target.files;
    handleYapeFiles(files);
  });

  function handleYapeFiles(files) {
    if (!files || files.length === 0) {
      return;
    }
    const file = files[0];
    // Tipo MIME imagen
    if (!file.type.startsWith("image/")) {
      yapeErrorDiv.textContent = "Archivo no válido: por favor selecciona una imagen de QR.";
      yapeFile.value = "";
      return;
    }
    // Extensión permitida
    const allowedExt = ["jpg","jpeg","png"];
    const ext = file.name.split(".").pop().toLowerCase();
    if (!allowedExt.includes(ext)) {
      yapeErrorDiv.textContent = "Formato no permitido: solo jpg/jpeg/png.";
      yapeFile.value = "";
      return;
    }
    // Tamaño máximo 2MB
    if (file.size > 2 * 1024 * 1024) {
      yapeErrorDiv.textContent = "La imagen es demasiado grande (máx. 2 MB).";
      yapeFile.value = "";
      return;
    }
    // Validación de teléfono Yape
    const tel = yapeTelefono.value.trim();
    if (!/^[9]\d{8}$/.test(tel)) {
      document.querySelector(".error[data-error='yapeTelefono']").textContent = "Teléfono inválido: debe tener 9 dígitos empezando con 9.";
      return;
    } else {
      document.querySelector(".error[data-error='yapeTelefono']").textContent = "";
    }
    // Validación código de operación (si tiene valor)
    const ref = yapeRef.value.trim();
    if (ref && ref.length > 8) {
      document.querySelector(".error[data-error='yapeRef']").textContent = "Código de operación demasiado largo (máx. 8 caracteres).";
      return;
    } else {
      document.querySelector(".error[data-error='yapeRef']").textContent = "";
    }

    // Si todo ok → vista previa
    yapeErrorDiv.textContent = "";
    const reader = new FileReader();
    reader.onload = function(e) {
      yapeImg.src = e.target.result;
      yapePreviewDiv.hidden = false;
    };
    reader.readAsDataURL(file);
  }

  // Validación del formulario de pago al enviar
  formPago.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Validaciones comunes
    if (!tycCheckbox.checked) {
      alert("Debes aceptar términos y condiciones.");
      return;
    }

    if (!cicloSelect.value || !selectedCuotaId) {
      alert("Información incompleta, vuelve al paso anterior para completar.");
      return;
    }

    // Según método de pago activo:
    const metodoActual = rMetodo.textContent;

    if (metodoActual === 'Yape') {
      // Validar teléfono
      const tel = yapeTelefono.value.trim();
      if (!/^[9]\d{8}$/.test(tel)) {
        document.querySelector(".error[data-error='yapeTelefono']").textContent = "Teléfono inválido: debe tener 9 dígitos empezando con 9.";
        return;
      } else {
        document.querySelector(".error[data-error='yapeTelefono']").textContent = "";
      }
      // Validar archivo cargado
      if (!yapeFile.files || yapeFile.files.length === 0) {
        yapeErrorDiv.textContent = "Por favor selecciona una imagen de QR.";
        return;
      }
    }

    // … aquí podrías añadir validaciones para tarjeta, etc.

    // Simulación de pago
    btnPagar.disabled = true;
    btnPagar.textContent = 'Procesando…';
    await new Promise(res => setTimeout(res, 1200));

    rCuota.textContent   = "Cuota #" + selectedCuotaId;
    rMonto.textContent   = selectedMonto;
    updateProgress(3);
    formPago.hidden       = true;
    document.getElementById("comprobante").hidden = false;

    btnPagar.disabled     = false;
    btnPagar.textContent  = 'Pagar cuota';
  });
});
</script>


</body>
</html>
